<!doctype html>
<html>
  <head>
    <title>Auto Collections</title>
    <style>      
    .title-match-container {
        margin-bottom: 10px;
        display: flex;
        align-items: center;
      }
      .match-type-container {
        width: 100px;
        margin-right: 10px;
      }
      .match-type-select {
        width: 100%;
      }
      .title-match-input {
        flex: 1;
        margin-right: 10px;
      }
      .collection-name-input {
        flex: 1;
        margin-right: 10px;
      }
      .case-sensitive-check {
        margin-right: 10px;
        display: flex;
        align-items: center;
      }
      .case-label {
        white-space: nowrap;
        margin-right: 5px;
      }
      .add-title-match-button {
        margin-bottom: 15px;
      }
      .remove-button {
        margin-left: 10px;
        min-width: 40px;
      }
      #title-match-pairs {
        margin-bottom: 20px;
      }
      .help-text {
        font-size: 0.9em;
        color: #888;
        margin-top: 5px;
        margin-bottom: 15px;
      }
    </style>
  </head>

  <body>
    <div
      data-role="page"
      class="page type-interior pluginConfigurationPage tbsConfigurationPage"
      data-require="emby-input,emby-button,emby-select,emby-checkbox"
    >
      <div data-role="content">
        <div class="content-primary">
          <form class="tbsConfigurationPage">
            <div class="sectionTitleContainer flex align-items-center">
              <h2 class="sectionTitle">Auto Collections</h2>
              <a
                is="emby-linkbutton"
                class="raised button-alt headerHelpButton emby-button"
                target="_blank"
                href="https://github.com/johnpc/jellyfin-plugin-Auto-collections"
              >Help</a>
            </div>
            <div class="verticalSection">
              <div class="inputContainer">
                <label class="inputLabel inputLabelUnfocused" for="title-match-pairs">Auto Collections:</label>
                <div class="help-text">Create collections based on a string match. Select the type (Title, Studio, Genre, Actor, or Director), enter the string to match, and provide an collection name.</div>
                <div id="title-match-pairs"></div>
              </div>
              
              <button
                id="add-title-match-button"
                is="emby-button"
                type="button"
                class="raised add-title-match-button"
              >
                <span>Add Auto Collection</span>
              </button>
              
              <br />
              <button
                id="saveConfiguration"
                is="emby-button"
                class="raised button-submit block"
              >
                <span>Save</span>
              </button>
            </div>
            <br />
            <button
              is="emby-button"
              type="button"
              class="raised block"
              id="sync-Auto-collections"
              onclick="execute()"
            >
              <span>Sync Auto Collections</span>
            </button>
          </form>
        </div>
      </div>

      <script type="text/javascript" defer>
        function createTitleMatchPairElement(titleMatch = '', collectionName = '', caseSensitive = false, matchType = 0) {
          const container = document.createElement('div');
          container.className = 'title-match-container';
          container.style.display = 'flex';
          container.style.flexWrap = 'wrap';
          container.style.alignItems = 'center';
          container.style.padding = '8px';
          container.style.marginBottom = '10px';
          container.style.borderRadius = '4px';
          container.style.backgroundColor = 'rgba(0,0,0,0.05)';
            
          // Create match type dropdown
          const matchTypeContainer = document.createElement('div');
          matchTypeContainer.className = 'match-type-container';
          matchTypeContainer.style.marginRight = '10px';
          matchTypeContainer.style.minWidth = '100px';
          matchTypeContainer.style.flex = '0 0 100px';
          
          const matchTypeSelect = document.createElement('select');
          matchTypeSelect.is = 'emby-select';
          matchTypeSelect.className = 'match-type-select';
            
          // Add match type options
          const options = [
            { value: '0', text: 'Title' },
            { value: '1', text: 'Genre' },
            { value: '2', text: 'Studio' },
            { value: '3', text: 'Actor' },
            { value: '4', text: 'Director' }
          ];
          
          options.forEach(opt => {
            const option = document.createElement('option');
            option.value = opt.value;
            option.text = opt.text;
            matchTypeSelect.appendChild(option);
          });
            
          // Set the selected option based on matchType parameter
          if (matchType !== undefined) {
            matchTypeSelect.value = matchType.toString();
          }
          
          matchTypeContainer.appendChild(matchTypeSelect);
          
          // This ensures the Emby select component is properly initialized
          setTimeout(() => {
            if (matchTypeSelect.embyInit) {
              matchTypeSelect.embyInit();
            } else if (window.EmbyWebComponents && window.EmbyWebComponents.autoFocus) {
              window.EmbyWebComponents.autoFocus(matchTypeSelect.parentNode);
            }
          }, 0);
            
          // Create a dynamic update for the placeholder text based on the selected match type
          const updatePlaceholder = (select) => {
            const matchType = parseInt(select.value, 10);
            const input = container.querySelector('.title-match-input');
            if (input) {
              switch(matchType) {
                case 1: // Genre
                  input.placeholder = 'Genre to match (e.g. Action, Comedy)';
                  break;
                case 2: // Studio
                  input.placeholder = 'Studio to match (e.g. Marvel, Paramount)';
                  break;
                case 3: // Actor
                  input.placeholder = 'Actor name to match (e.g. Tom Hanks, Scarlett)';
                  break;
                case 4: // Director
                  input.placeholder = 'Director name to match (e.g. Spielberg, Nolan)';
                  break;
                default: // Title
                  input.placeholder = 'Text in title to match';
              }
            }
          };
          
          // Add change event to update placeholder when match type changes
          matchTypeSelect.addEventListener('change', () => {
            updatePlaceholder(matchTypeSelect);
          });
            
          const titleMatchContainer = document.createElement('div');
          titleMatchContainer.style.flex = '1 1 200px';
          titleMatchContainer.style.marginRight = '10px';
          
          const titleMatchInput = document.createElement('input');
          titleMatchInput.is = 'emby-input';
          titleMatchInput.type = 'text';
          titleMatchInput.className = 'title-match-input';
          titleMatchInput.style.width = '100%';
          titleMatchInput.placeholder = 'Match String';
          titleMatchInput.value = titleMatch;
          
          titleMatchContainer.appendChild(titleMatchInput);
          
          // Set initial placeholder based on match type
          setTimeout(() => updatePlaceholder(matchTypeSelect), 0);
            
          const collectionNameContainer = document.createElement('div');
          collectionNameContainer.style.flex = '1 1 200px';
          collectionNameContainer.style.marginRight = '10px';
          
          const collectionNameInput = document.createElement('input');
          collectionNameInput.is = 'emby-input';
          collectionNameInput.type = 'text';
          collectionNameInput.className = 'collection-name-input';
          collectionNameInput.style.width = '100%';
          collectionNameInput.placeholder = 'Collection Name';
          collectionNameInput.value = collectionName;
          
          collectionNameContainer.appendChild(collectionNameInput);
            
          // Create case-sensitive checkbox
          const caseCheckContainer = document.createElement('div');
          caseCheckContainer.className = 'case-sensitive-check';
          caseCheckContainer.style.flex = '0 0 auto';
          caseCheckContainer.style.display = 'flex';
          caseCheckContainer.style.alignItems = 'center';
          caseCheckContainer.style.marginRight = '10px';
          
          const caseCheckboxWrapper = document.createElement('div');
          caseCheckboxWrapper.style.marginRight = '5px';
          
          const caseCheckbox = document.createElement('input');
          caseCheckbox.is = 'emby-checkbox';
          caseCheckbox.type = 'checkbox';
          caseCheckbox.className = 'case-sensitive-checkbox';
          caseCheckbox.checked = caseSensitive;
          
          const caseLabel = document.createElement('label');
          caseLabel.className = 'case-label';
          caseLabel.textContent = 'Case Sensitive';
          caseLabel.style.marginLeft = '5px';
          caseLabel.style.fontSize = '14px';
          
          caseCheckboxWrapper.appendChild(caseCheckbox);
          caseCheckContainer.appendChild(caseCheckboxWrapper);
          caseCheckContainer.appendChild(caseLabel);
            
          const removeButton = document.createElement('button');
          removeButton.is = 'emby-button';
          removeButton.type = 'button';
          removeButton.className = 'remove-button';
          removeButton.innerHTML = '<span>âœ•</span>';
          removeButton.style.flex = '0 0 auto';
          removeButton.style.minWidth = '32px';
          removeButton.style.height = '32px';
          removeButton.style.padding = '0';
          removeButton.style.borderRadius = '50%';
          removeButton.onclick = function() {
            container.remove();
          };
          
          // Add all components to container in order
          container.appendChild(matchTypeContainer);
          container.appendChild(titleMatchContainer);
          container.appendChild(collectionNameContainer);
          container.appendChild(caseCheckContainer);
          container.appendChild(removeButton);
          
          return container;
        }
        
        function loadConfig() {
          window.ApiClient.getPluginConfiguration(
            "06ebf4a9-1326-4327-968d-8da00e1ea2eb"
          ) // Plugin Id
            .then(function (config) {
              const titleMatchPairsContainer = document.querySelector("#title-match-pairs");
              titleMatchPairsContainer.innerHTML = '';
                
              // Check if we have the TitleMatchPairs property
              if (config.TitleMatchPairs && config.TitleMatchPairs.length > 0) {
                config.TitleMatchPairs.forEach(pair => {                  // Convert MatchType enum string to numeric value for the dropdown
                  let matchTypeValue = 0; // Default to Title
                  if (pair.MatchType !== undefined) {
                    switch (pair.MatchType) {
                      case "Title":
                        matchTypeValue = 0;
                        break;
                      case "Genre":
                        matchTypeValue = 1;
                        break;
                      case "Studio":
                        matchTypeValue = 2;
                        break;
                      case "Actor":
                        matchTypeValue = 3;
                        break;
                      case "Director":
                        matchTypeValue = 4;
                        break;
                      // Fallback for numeric values (backward compatibility)
                      default:
                        if (typeof pair.MatchType === 'number') {
                          matchTypeValue = pair.MatchType;
                        }
                    }
                  }
                  
                  const element = createTitleMatchPairElement(
                    pair.TitleMatch, 
                    pair.CollectionName, 
                    pair.CaseSensitive, 
                    matchTypeValue
                  );
                  titleMatchPairsContainer.appendChild(element);
                });
              } 
              else {
                // If no configuration exists yet, add one empty row
                const element = createTitleMatchPairElement();
                titleMatchPairsContainer.appendChild(element);
              }
            })
            .catch(function (error) {
              console.error(error);
              // Add an empty row if there's an error
              const element = createTitleMatchPairElement();
              document.querySelector("#title-match-pairs").appendChild(element);
            });
        }
          
        function saveConfig() {
          const titleMatchContainers = document.querySelectorAll('.title-match-container');
          const titleMatchPairs = [];
            
          titleMatchContainers.forEach(container => {
            // Handle our new nested structure
            const titleMatchInput = container.querySelector('.title-match-input');
            const collectionNameInput = container.querySelector('.collection-name-input');
            const caseSensitiveCheckbox = container.querySelector('.case-sensitive-checkbox');
            const matchTypeSelect = container.querySelector('.match-type-select');
              if (titleMatchInput.value.trim()) {
              const titleMatch = titleMatchInput.value.trim();
              const collectionName = collectionNameInput.value.trim();
              const caseSensitive = caseSensitiveCheckbox.checked;
              // Convert numeric value to enum string representation
              const matchTypeValue = parseInt(matchTypeSelect.value, 10);
              let matchTypeString;
              switch (matchTypeValue) {
                case 0:
                  matchTypeString = "Title";
                  break;
                case 1:
                  matchTypeString = "Genre";
                  break;
                case 2:
                  matchTypeString = "Studio";
                  break;
                case 3:
                  matchTypeString = "Actor";
                  break;
                case 4:
                  matchTypeString = "Director";
                  break;
                default:
                  matchTypeString = "Title";
              }
              
              titleMatchPairs.push({
                TitleMatch: titleMatch,
                CollectionName: collectionName || null, // Use null if collection name is empty
                CaseSensitive: caseSensitive,
                MatchType: matchTypeString
              });
            }
          });
          
          const config = {
            TitleMatchPairs: titleMatchPairs,
            // Keep these empty for backward compatibility
            TagTitlePairs: [],
            Tags: []
          };
          
          window.ApiClient.updatePluginConfiguration(
            "06ebf4a9-1326-4327-968d-8da00e1ea2eb",
            config
          )
            .then(() => alert("Update success"))
            .catch(function (error) {
              console.error(error);
              alert("Error saving configuration");
            });
        }
        
        function execute() {
          var request = {
            url: ApiClient.getUrl("/AutoCollections/AutoCollections"),
            type: "POST"
          };

          ApiClient.fetch(request)
            .then(function () {
              Dashboard.alert("Executing Auto Collections...");
            })
            .catch(function () {
              Dashboard.alert({
                message: "Unexpected error occurred!"
              });
            });
        }

        // Initialize the page
        loadConfig();
        
        // Add event listeners
        document.querySelector("#saveConfiguration").addEventListener("click", saveConfig);
        document.querySelector("#add-title-match-button").addEventListener("click", function() {
          const element = createTitleMatchPairElement();
          document.querySelector("#title-match-pairs").appendChild(element);
        });
      </script>
    </div>
  </body>
</html>